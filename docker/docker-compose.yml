services:
  mysql-mcp-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "${MCP_PORT:-8080}:8080"
    environment:
      # Transport Configuration
      MCP_TRANSPORT: http-stream
      MCP_PORT: "8080"

      # Authentication (comma-separated API keys)
      API_KEYS: ${API_KEYS}

      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-*}

      # MySQL Configuration
      MYSQL_HOST: ${MYSQL_HOST:-localhost}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_CONNECTION_LIMIT: ${MYSQL_CONNECTION_LIMIT:-10}
      MYSQL_CONNECT_TIMEOUT: ${MYSQL_CONNECT_TIMEOUT:-60000}

      # Query Settings
      QUERY_TIMEOUT: ${QUERY_TIMEOUT:-30000}
      MAX_ROWS: ${MAX_ROWS:-1000}

      # Cloud SQL Proxy (optional)
      CLOUD_SQL_PROXY_ENABLED: ${CLOUD_SQL_PROXY_ENABLED:-false}
      CLOUD_SQL_INSTANCE: ${CLOUD_SQL_INSTANCE:-}
      CLOUD_SQL_PROXY_PORT: ${CLOUD_SQL_PROXY_PORT:-3307}
      GOOGLE_APPLICATION_CREDENTIALS: /credentials.json
      CLOUD_SQL_PROXY_STARTUP_TIMEOUT: ${CLOUD_SQL_PROXY_STARTUP_TIMEOUT:-30000}
    volumes:
      # Mount service account key if using Cloud SQL
      - ${GOOGLE_APPLICATION_CREDENTIALS:-/dev/null}:/credentials.json:ro
    restart: unless-stopped

  # Optional: Local MySQL for development
  mysql:
    image: mysql:8.0
    profiles:
      - dev
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-testdb}
      MYSQL_USER: ${MYSQL_USER:-testuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-testpass}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
